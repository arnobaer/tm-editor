#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# Repository path   : $HeadURL:  $
# Last committed    : $Revision:  $
# Last changed by   : $Author:  $
# Last changed date : $Date: $
#

import tmEditor

from PyQt4.QtGui import QApplication

import argparse
import logging
import sys, os

EXIT_OK = 0
EXIT_FAIL = 1

def abspath_t(path):
    return os.path.abspath(path)

def parse():
    parser = argparse.ArgumentParser()
    parser.add_argument('filenames',
        metavar = '<file>',
        nargs = '*',
        type = abspath_t,
        help = "trigger menu XML file",
    )
    parser.add_argument('-v', '--verbose',
        action = 'count',
        help = "increase output verbosity",
    )
    parser.add_argument('-V', '--version',
        action = 'version',
        version = "%(prog)s {0}".format(tmEditor.MainWindow.Version),
        help = "show the application's version",
    )
    return parser.parse_args()

def main():
    """Main routine."""
    args = parse()

    # Setup console logging and debug level.
    loggingLevel = logging.DEBUG if args.verbose else logging.INFO
    logging.basicConfig(format = '%(levelname)s: %(message)s', level = loggingLevel)

    # As things are getting serious let's start logging to file.
    handler = logging.FileHandler('tm-editor.log', mode = 'a')
    handler.setFormatter(logging.Formatter(fmt = '%(asctime)s %(levelname)s : %(message)s', datefmt='%Y-%m-%d %H:%M:%S'))
    handler.setLevel(loggingLevel)
    logging.getLogger().addHandler(handler)

    # Create application window.
    try:
        app = QApplication(sys.argv)
        logging.debug("launching L1-Trigger Menu Editor, version %s", tmEditor.MainWindow.Version)
        window = tmEditor.MainWindow()
        # Load documents from command line (optional).
        for filename in args.filenames:
            logging.debug("loading file %s", filename)
            window.loadDocument(filename)
        window.show()
        return app.exec_()
    except RuntimeError, message:
        logging.error(message)
        return EXIT_FAIL
    return EXIT_OK

if __name__ == '__main__':
    sys.exit(main())
